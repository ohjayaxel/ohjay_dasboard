# Google Ads v16 Error - Root Cause Analysis & Fix Plan

## 1. Current Implementation Verification

### ‚úÖ Confirmed: All Active Code Uses v21

**File: `lib/integrations/googleads.ts`**

1. **API Endpoint (Line 9):**
   ```typescript
   const GOOGLE_REPORTING_ENDPOINT = 'https://googleads.googleapis.com/v21/customers';
   ```
   - ‚úÖ Version: **v21**
   - ‚úÖ Host: `https://googleads.googleapis.com`
   - ‚úÖ Status: **CORRECT**

2. **Function: `fetchAccessibleGoogleAdsCustomers` (Lines 347-446):**
   ```typescript
   const response = await fetch(
     `${GOOGLE_REPORTING_ENDPOINT}:listAccessibleCustomers`,
     {
       method: 'POST',
       headers: {
         Authorization: `Bearer ${accessToken}`,
         'developer-token': GOOGLE_DEVELOPER_TOKEN,
         'Content-Type': 'application/json',
       },
       body: JSON.stringify({}),
     },
   );
   ```
   - ‚úÖ URL: `https://googleads.googleapis.com/v21/customers:listAccessibleCustomers`
   - ‚úÖ Method: **POST**
   - ‚úÖ Version: **v21**
   - ‚úÖ Implementation: **CORRECT**

3. **OAuth Callback: `handleGoogleAdsOAuthCallback` (Lines 175-267):**
   - ‚úÖ **Does NOT call `fetchAccessibleGoogleAdsCustomers`**
   - ‚úÖ Removed in recent fix (lines 227-248 use simplified logic)
   - ‚úÖ Status: **No API calls during OAuth**

## 2. All Active Call Paths

### Search Results for `fetchAccessibleGoogleAdsCustomers`:

**Found: 1 definition, 0 active call sites**

1. **Definition only:**
   - File: `lib/integrations/googleads.ts:347`
   - Status: **Function exists but is NOT called anywhere**

2. **Previously called in:**
   - ‚ùå `handleGoogleAdsOAuthCallback` - **REMOVED** (no longer calls it)
   - ‚ùå `refreshGoogleAdsCustomers` - **Does NOT call it** (only sets error message)

### Search Results for `listAccessibleCustomers`:

**Found: 1 usage in active code**

1. **File: `lib/integrations/googleads.ts:364`**
   ```typescript
   `${GOOGLE_REPORTING_ENDPOINT}:listAccessibleCustomers`
   ```
   - Used in: `fetchAccessibleGoogleAdsCustomers` function
   - Status: **Function defined but NOT called**
   - Version: **v21** ‚úÖ

### Search Results for `/v16/`:

**Found: 2 references - BOTH are non-functional:**

1. **File: `GOOGLE_ADS_FIX_ANALYSIS.md`**
   - Type: **Documentation only** (old analysis file)
   - Status: **Not executable code**

2. **File: `app/(dashboard)/admin/actions.ts:1898`**
   - Type: **Comment only**
   ```typescript
   // Note: Automatic customer fetching is not available for Google Ads API v16
   ```
   - Status: **Outdated comment** (should say "disabled" not "v16")

### Search Results for `customers_error`:

**Found: 3 locations - ALL are for reading/displaying stored errors:**

1. **File: `lib/integrations/googleads.ts:262`**
   - Sets `customers_error` in database during OAuth callback
   - Sets helpful message, NOT a v16 error

2. **File: `app/(dashboard)/admin/actions.ts:1929`**
   - Sets `customers_error` when refresh button is clicked
   - Sets helpful message about manual entry

3. **File: `app/(dashboard)/admin/tenants/[tenantSlug]/integrations/page.tsx:170-173`**
   - **READS `customers_error` from database**
   - **DISPLAYS it in UI (lines 311-315, 322-326)**
   - **THIS IS WHERE THE OLD v16 ERROR IS SHOWN**

## 3. Root Cause Analysis

### ‚úÖ DEFINITIVE EXPLANATION:

**The v16 error is NOT generated by current code. It is a STALE DATABASE VALUE.**

**Evidence:**

1. **No active code path generates v16 errors:**
   - `handleGoogleAdsOAuthCallback` does NOT call `fetchAccessibleGoogleAdsCustomers`
   - `refreshGoogleAdsCustomers` does NOT call any API
   - All code uses v21

2. **Error is stored in database:**
   - Field: `connections.meta->>'customers_error'`
   - Contains: Old HTML error message with `/v16/customers:listAccessibleCustomers`

3. **UI reads and displays stored error:**
   - File: `app/(dashboard)/admin/tenants/[tenantSlug]/integrations/page.tsx:170-173`
   - Code: `const googleCustomersError = typeof googleDetails.customers_error === 'string' ...`
   - Display: Lines 311-315, 322-326 show the error to user

4. **No code clears old errors:**
   - When OAuth callback runs, it sets NEW `customers_error` (lines 262-264)
   - BUT: If `baseMeta` from existing connection contains old error, it might be merged
   - Actually, looking at line 255: `meta: { ... }` creates new object, so old error SHOULD be overwritten
   - **However**: The old error persists because it was set BEFORE the fix

**Conclusion:** The error message is from a **previous OAuth connection attempt** when the code was using v16. The error was stored in the database and is now being read and displayed by the UI.

## 4. Required Fixes

### Fix 1: Update Outdated Comment
**File: `app/(dashboard)/admin/actions.ts:1898`**
```diff
-  // Note: Automatic customer fetching is not available for Google Ads API v16
+  // Note: Automatic customer fetching is disabled. Manual Customer ID entry required.
```

### Fix 2: Clean Up Old Database Errors
**SQL Script:**
```sql
-- Clear old v16 errors and replace with helpful message
UPDATE connections 
SET meta = jsonb_set(
  meta, 
  '{customers_error}', 
  '"Please manually enter your Google Ads Customer ID in the connection settings."'::jsonb
)
WHERE source = 'google_ads' 
  AND meta->>'customers_error' LIKE '%v16%';
```

**Alternative: Clear on next OAuth callback**
- The OAuth callback already overwrites `customers_error` (line 262-264)
- So reconnecting will clear the old error
- But proactively cleaning is better UX

### Fix 3: Ensure OAuth Callback Always Sets Fresh Error Message
**File: `lib/integrations/googleads.ts:250-266`**
- ‚úÖ Already correct: Creates new meta object, doesn't merge old `customers_error`
- ‚úÖ Will overwrite old errors on next OAuth connection

## 5. Summary

### What is Implemented Today (v21):
- ‚úÖ `GOOGLE_REPORTING_ENDPOINT` uses v21
- ‚úÖ `fetchAccessibleGoogleAdsCustomers` uses v21 (but not called)
- ‚úÖ OAuth callback does NOT call API (simplified flow)
- ‚úÖ Edge Function uses v21 for sync

### What Still References v16:
- ‚ö†Ô∏è **Outdated comment** in `app/(dashboard)/admin/actions.ts:1898`
- üìÑ **Documentation file** `GOOGLE_ADS_FIX_ANALYSIS.md` (non-executable)

### What is Actually Causing the v16 Error:
- üéØ **STALE DATABASE VALUE** in `connections.meta->>'customers_error'`
- üéØ Set during a previous OAuth attempt when code used v16
- üéØ Displayed by UI which reads from database (line 170-173 of integrations page)

### Minimal Steps to Eliminate v16 Error:

1. **Update comment** (cosmetic fix):
   ```typescript
   // app/(dashboard)/admin/actions.ts:1898
   // Change "v16" comment to generic message
   ```

2. **Clean database** (immediate fix):
   ```sql
   UPDATE connections 
   SET meta = jsonb_set(meta, '{customers_error}', '"Please manually enter your Google Ads Customer ID in the connection settings."'::jsonb)
   WHERE source = 'google_ads' AND meta->>'customers_error' LIKE '%v16%';
   ```

3. **Verify** (after cleanup):
   - Check integrations page shows new message
   - Reconnect Google Ads to ensure fresh error message is set

## 6. Verification Checklist

- ‚úÖ All active code uses v21
- ‚úÖ No active code path calls v16 endpoints
- ‚ö†Ô∏è Database contains old v16 error (needs cleanup)
- ‚ö†Ô∏è UI displays stored database error (will be fixed by cleanup)
- ‚ö†Ô∏è Comment still mentions v16 (cosmetic fix needed)


